
```{r setup, include=FALSE}
# leave this chunk alone
options(knitr.table.format = "html") 
knitr::opts_chunk$set(warning = FALSE, message = FALSE, 
  comment = NA, dpi = 300)
```

```{r load-libraries, echo=FALSE}

library(tidyverse) # the usual stuff: dplyr, readr, and other goodies
library(lubridate) # to handle dates
library(GGally) # for correlation-scatter plot matrix
library(ggfortify) # to produce residual diagnostic plots
library(rsample) # to split dataframe in training- & testing sets
library(janitor) # clean_names()
library(broom) # use broom:augment() to get tidy table with regression output, residuals, etc
library(huxtable) # to get summary table of all models produced
library(moderndive) # for getting regression tables
library(skimr) # for skim
library(mosaic)
library(leaflet) # for interactive HTML maps
library(tidytext)
library(viridis)
library(vroom)
```


```{r load_data, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}

# use cache=TRUE so you dont donwload the data everytime you knit

listings <- vroom("http://data.insideairbnb.com/china/beijing/beijing/2021-09-28/data/listings.csv.gz") %>% 
       clean_names()

```


Even though there are many variables in the dataframe, here is a quick description of some of the variables collected.

- `price` = cost per night 
- `property_type`: type of accommodation (House, Apartment, etc.)
- `room_type`:

  - Entire home/apt (guests have entire place to themselves)
  - Private room (Guests have private room to sleep, all other rooms shared)
  - Shared room (Guests sleep in room shared with others)

- `number_of_reviews`: Total number of reviews for the listing
- `review_scores_rating`: Average review score (0 - 100)
- `longitude` , `latitude`: geographical coordinates to help us locate the listing
- `neighbourhood*`: three variables on a few major neighbourhoods in each city 

```{r}
listings1 <- listings %>% 
  group_by(property_type) %>% 
  summarize(count = n()) 
view(listings1)
```

# Exploratory Data Analysis

## Looking at the raw values

```{r}
listings %>%
glimpse()
```

## Summary statistics

```{r}
listings %>%
skim()
```

## Data wrangling

Since `price` is a quantitative variable, we need to make sure it is stored as numeric data `num` in the dataframe.

```{r}
listings <- listings %>% 
  mutate(price = parse_number(price))
```

```{r}
typeof(listings$price)
```
```{r}
skim(listings)
```

## Data visualisations

```{r}
# Price (per bedroom) distribution by room type
listings %>%
  filter (!is.na(room_type)) %>%
  mutate ( price_per_bedroom := price/bedrooms ) %>%
  ggplot(aes(x=price_per_bedroom, colour = room_type, alpha=0.4)) +
  geom_histogram() +
  facet_wrap(~room_type, scales = "free")
  theme_bw() +
  labs (title = "Price Distribution by Room Type")
```

```{r}
# Box plot of price per bedroom by neighbourhoods
listings %>%
  filter (!is.na(neighbourhood_cleansed)) %>%
  mutate ( price_per_bedroom := price/bedrooms ) %>%
ggplot(aes( x = factor(neighbourhood_cleansed))) +
  geom_boxplot(aes(y = price_per_bedroom)) +
  theme( axis.text.x = element_text( angle= 45, hjust = 1)) +  
  scale_y_continuous(limits = c(0,2500)) +
  labs(title = "Box Plot of Price per Bedroom by Neighbourhoods")
```

```{r}
# Correlation matrix of key variables
listings <- listings %>% 
  mutate(log_price := log(price)) # Mutate a new column showing log price
ggpairs(listings, columns = c("log_price",  "accommodates",  "bedrooms", "availability_30", "availability_60", "review_scores_rating", "beds", "number_of_reviews", "minimum_nights"))
```

```{r}
# Box plot of price per bedroom by whether the host is super host
listings %>%
  filter (!is.na(host_is_superhost)) %>%
  mutate ( price_per_bedroom := price/bedrooms ) %>%
ggplot(aes( x = factor(host_is_superhost))) +
  geom_boxplot(aes(y = price_per_bedroom)) +
  theme( axis.text.x = element_text( angle= 45, hjust = 1)) +  
  scale_y_continuous(limits = c(0,2500)) +
  labs(title = "Box Plot of Price per Bedroom by the host")
```

## Propery types

```{r}
listings <- listings %>%
  mutate(prop_type_simplified = case_when(
    property_type %in% c("Entire villa","Entire residential home", "Farm stay","Private room in farm stay") ~ property_type, 
    TRUE ~ "Other"
  ))
```

Use the code below to check that `prop_type_simplified` was correctly made.

```{r}
listings %>%
  count(property_type, prop_type_simplified) %>%
  arrange(desc(n))        
```        

Airbnb is most commonly used for travel purposes, i.e., as an alternative to traditional hotels. We only want to include  listings in our regression analysis that are intended for travel purposes:

```{r}
listings %>%
  count(minimum_nights)
```
The most common value for minimum_nights is 1.

There are some unusual figures for minimum_nights such as, Airbnb does this to encourage customers to stay longer and spend more money.`

```{r}
listings <- listings %>% 
  filter(minimum_nights <= 4)
```  

# Mapping

```{r, out.width = '80%'}
leaflet(data = filter(listings, minimum_nights <= 4)) %>% 
  addProviderTiles("OpenStreetMap.Mapnik") %>% 
  addCircleMarkers(lng = ~longitude, 
                   lat = ~latitude, 
                   radius = 1, 
                   fillColor = "blue", 
                   fillOpacity = 0.4, 
                   popup = ~listing_url,
                   label = ~property_type)
```
